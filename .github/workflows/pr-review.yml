name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: ${{ github.repository }}-${{ github.event.number || github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: coderabbitai/ai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          debug: false
          review_simple_changes: false
          review_comment_lgtm: false
          openai_light_model: gpt-4o-mini
          openai_heavy_model: gpt-4o
          openai_timeout_ms: 900000
          language: en
          path_filters: |
            !**/*.lock
            !**/pnpm-lock.yaml
            !**/bun.lock
            !**/Cargo.lock
            !**/*.png
            !**/*.jpg
            !**/*.ico
            !**/*.icns
            !**/*.svg
            !**/binaries/**
          system_message: |
            You are an expert code reviewer for ProxyPal, a Tauri desktop app with:
            - Frontend: SolidJS + TypeScript + Tailwind CSS
            - Backend: Rust (Tauri) + Go (CLIProxyAPI sidecar)

            Focus on:
            1. Security issues (credentials, XSS, injection)
            2. Type safety and error handling
            3. Performance and memory leaks
            4. Code style consistency
            5. Potential bugs and edge cases

            Be concise. Only comment on issues that matter.
            Approve PRs that are ready to merge.
          summarize: |
            Provide a brief summary of the changes in this PR:
            - What does this PR do?
            - Are there any concerns?
            - Recommendation: Approve / Request Changes / Comment
